[TOC]



# 一、 NNIE概述









# 二、 测试

NNIE在sdk中存在测试例程，其中可以直接运行，板卡开机启动挂载相关驱动，然后编译测试NNIE功能，其中NNIE部分单独测试，并不做任何图像处理，如果有需要，后期可以做图像处理。

## 1.开机启动

我的开机启动命令如下：开机挂载硬盘空间，以及加载驱动，我的驱动部分都存放在/home/01ko/ko路径下面，在```/etc/profile```下面添加如下代码：

```bash
mount -t ext4 /dev/mmcblk0p6 /home                                                                                                                                                                                                                                                                                                    
insmod /home/01ko/hi_ipcm.ko                                                                                                                                         
insmod /home/01ko/hi_virt-tty.ko                                                                                                                                     
                                                                                                                                                              
cd /home/01ko/ko                                                                                                                                                     
./load3559av100_multicore -i sensor0 imx334                                                                                                                          
cd - 
```

重新启动。

## 2.编译例程

测试例程在sdk中，在我的电脑路径下编译，便能够成功生成可执行文件。

```bash
docker start cang
docker attach \
cd /workspace/sdk/02sdk/Hi3559AV100R001C02SPC020/01.software/board/Hi3559AV100_SDK_V2.0.2.0/mpp/sample/svp/multi-core
make -j12
cd nnie
make -j12
```

执行上述指令后并可以生成可执行文件```sample_nnie_main```，在目标机运行该程序。

```bash
/home/00shell/nfs.sh
cd /mnt/04work/02hi3559a/02sdk/Hi3559AV100R001C02SPC020/01.software/board/Hi3559AV100_SDK_V2.0.2.0/mpp/sample/svp/multi-core/nnie
./sample_nnie_main 8
```

可以看到已经成功识别了目标。

## 3.修改例程

很多时候我们会训练自己的模型，这里选择使用自己训练的模型，分别生成了模型文件```ship_inst.wk```和测试文件```1.bgr```，该模型的输出分类为5类，其具体修改如下：

* 将模型拷贝到对应的目标文件夹
* 修改例程中对应的参数
* 编译成功可执行文件，测试可执行文件

### 1) 拷贝文件

```bash
cp ship_inst.wk data/nnie_model/detection/
mkdir -p data/nnie_image/rgb
cp 1.bgr data/nnie_image/rgb
```

### 2) 修改参数

sample_nnie.c

```c
void SAMPLE_SVP_NNIE_Yolov3(void)
{
    HI_CHAR *pcSrcFile = "./data/nnie_image/rgb/1.bgr";
    HI_CHAR *pcModelName = "./data/nnie_model/detection/ship_inst.wk";
   	...
}

static HI_S32 SAMPLE_SVP_NNIE_Yolov3_SoftwareInit(SAMPLE_SVP_NNIE_CFG_S* pstCfg,
    SAMPLE_SVP_NNIE_PARAM_S *pstNnieParam, SAMPLE_SVP_NNIE_YOLOV3_SOFTWARE_PARAM_S* pstSoftWareParam)
{
	...

    // pstSoftWareParam->u32ClassNum = 80;			//这里是输出的类别
    pstSoftWareParam->u32ClassNum = 5;
    pstSoftWareParam->au32GridNumHeight[0] = 13;	//这里是实际尺寸除以32
    pstSoftWareParam->au32GridNumHeight[1] = 26;	//这里是实际尺寸除以16
    pstSoftWareParam->au32GridNumHeight[2] = 52;	//这里是实际尺寸除以8
    pstSoftWareParam->au32GridNumWidth[0] = 13;
    pstSoftWareParam->au32GridNumWidth[1] = 26;
    pstSoftWareParam->au32GridNumWidth[2] = 52;
    
    pstSoftWareParam->u32MaxRoiNum = 8;				//一份图最多检测类别
    ...
}
```

sample_svp_nnie_software.h

```c
#define SAMPLE_SVP_NNIE_YOLOV3_EACH_BBOX_INFER_RESULT_NUM   10 /*yolov3 inference result num of each bbox*/
// #define SAMPLE_SVP_NNIE_YOLOV3_EACH_BBOX_INFER_RESULT_NUM   85 /*yolov3 inference result num of each bbox*/
```

该参数为最大检测的类别加5。

### 3) 编译测试

在docker容器。

```bash
make clean
make -j12
```

在目标机

```bash
# ./sample_nnie_main 8
[Level]:Debug,[Func]:SAMPLE_COMM_SVP_CheckSysInit [Line]:82 [Info]:Svp mpi init ok!                                               [Level]:Info,[Func]:SAMPLE_SVP_NNIE_Yolov3 [Line]:2952 [Info]:Yolov3 Load model!                                                 [Level]:Info,[Func]:SAMPLE_SVP_NNIE_Yolov3 [Line]:2961 [Info]:Yolov3 parameter initialization!                                   [Level]:Info,[Func]:SAMPLE_SVP_NNIE_Yolov3 [Line]:2968 [Info]:Yolov3 start!                                                       [Level]:Info,[Func]:SAMPLE_SVP_NNIE_Yolov3 [Line]:3005 [Info]:Yolov3 result:                                                     [Level]:Info,[Func]:SAMPLE_SVP_NNIE_Detection_PrintResult [Line]:791 [Info]:==== The 3th class box info====                       [Level]:Info,[Func]:SAMPLE_SVP_NNIE_Detection_PrintResult [Line]:804 [Info]:0 72 416 277 0.997803                              [Level]:Debug,[Func]:SAMPLE_COMM_SVP_CheckSysExit [Line]:95 [Info]:Svp mpi exit ok! 
```

如上述反馈，已经测试成功了，其中用的测试图片为：

```c
HI_CHAR *pcSrcFile = "./data/nnie_image/rgb/2.bgr";
HI_CHAR *pcModelName = "./data/nnie_model/detection/ship_inst.wk";
```

# 三、 图片标注

上面的程序中输出了部分坐标，需要将坐标的数据进行标准以验证数据的正确性。

BGR的数据格式为原理数据，使用读文件读取数据即可，采用python编写部分验证性代码，代码如下：

```python
'''
Author: your name
Date: 2021-01-17 17:36:35
LastEditTime: 2021-01-17 22:58:41
LastEditors: Please set LastEditors
Description: In User Settings Edit
FilePath: /tf/test.py
'''
import os
import cv2
import numpy as np
import matplotlib.pyplot as plt



def test():
    f = open("./2.bgr", 'rb')
    data = f.read()
    data = np.frombuffer(data, dtype=np.uint8) 
    f.close()
    img_size = 416 * 416
    B1 = data[0:img_size * 3:3]
    G1 = data[1:img_size * 3:3]
    R1 = data[2:img_size * 3:3]

    B = np.reshape(B1,(416,-1))
    G = np.reshape(G1,(416,-1))
    R = np.reshape(R1,(416,-1))

    newimg = cv2.merge([B, G, R])

    ptLeftTop = (0, 72)
    ptRightBottom = (416, 277)
    point_color = (0, 255, 0) # BGR
    thickness = 3 
    lineType = 4
    cv2.rectangle(newimg, ptLeftTop, ptRightBottom, point_color, thickness, lineType)

    cv2.imshow("new", newimg)
    cv2.waitKey(0)

def main():
    test()

if __name__ == "__main__":
    main() 
```

输入图像如下：

![image-20210117225920869](/home/luocang/.config/Typora/typora-user-images/image-20210117225920869.png)



# 四、 官方demo



![image-20210118092139269](/home/luocang/.config/Typora/typora-user-images/image-20210118092139269.png)

