---
title: "Hi3559a_开发(六)-A53调试：定时器测试"
date: 2020-12-25T16:57:14+08:00
draft: false
tags: ["Hi3559a"]
---

# 一、建立工程
HI3559A总共存在16个定时器，主要实现定时计数功能，可以供操作系统用作系统时钟，也可以供应用程序用作定时和计数，其中主SOC存在12个定时器，M7部分存在4个定时器。
其具体配置参考《Hi3559A╱C V100 ultra-HD Mobile Camera SoC 用户指南.pdf》。

为了方便程序的管理，在git下新建一个分支用来做定时器测试。
```bash
git checkout -b test_timer
```

其测试部分代码如下：
user_timer.c
```c
#include "user_timer.h"

#if TIM10IR_EN
irqreturn_t timer10_isr(int a, void *arg){
    static uint16_t counter = 0;
    if(++counter == 20){
        counter = 0;
        dprintf("timer 2s!\n");
    }

    writel(1,TIM_INTCLR(Mytimer));     //清除中断向量
    return IRQ_HANDLED;
}
#endif

void timer10_initial(void){
    dprintf("start initial timer10\n");
    writel(300000,TIM_LOAD(Mytimer));   //10ms
    // writel(0,SC_CTRL);   //默认3M的计数器

    writel((1 << 7) | (1 << 6) | (1 << 5) | (1 << 1),TIM_CN(Mytimer)); //周期计数，不分频
#if TIM10IR_EN
    request_irq(NUM_HAL_INTERRUPT_TIMER10, timer10_isr, 0,"timer10_isr",NULL);
#endif
}

void timer_test(void){
    timer10_initial();
}
```
user_timer.h
```c
#ifndef __USER_TIMER_H__
#define __USER_TIMER_H__

#include "linux_head.h"

#define Mytimer             TIMER10_REG_BASE
#define TIM_LOAD(n)         (n + 0)
#define TIM_VALUE(n)        (n + 0x04)
#define TIM_CN(n)           (n + 0x08)
#define TIM_INTCLR(n)       (n + 0x0C)
#define TIM_RIS(n)          (n + 0x10)
#define TIM_MIS(n)          (n + 0x14)
#define TIM_BGLOAD(n)       (n + 0x18)
#define SC_CTRL             0x12020000

#define TIM10IR_EN          1

void timer_test(void);
void timer10_initial(void);

#endif
```

# 二、编译、测试
通过对上述代码进行编译， 其输出结果如下，发现串口每隔2s发生一个消息，说明定时器成功运行，并且中断成功设置。
![img](../images/pic7.png)

# 三、代码使用
上述的demo已经保存为了一个独立的分支，可以直接编译运行，其具体运行如下：
```bash
cd osdrv/platform/liteos_a53/liteos/sample/sample_osdrv
git checkout test_timer
make
```
经过上述步骤既可以生成可执行文件。
