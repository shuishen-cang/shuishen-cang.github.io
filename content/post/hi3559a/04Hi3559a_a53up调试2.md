---
title: "Hi3559a_开发(四)-A53调试：中断分析"
date: 2020-12-25T16:57:05+08:00
draft: false
tags: ["Hi3559a"]
---

# 一、 中断分析-linux部分
hi3559a的核心部署方式为multicore和big-little，在multicore方式中，所有跟媒体相关的代码都在linux系统，在big-little方式中，部分媒体相关的代码在liteos中，媒体代码与liteos存在较大的耦合。

在milticore方式中，所有的中断都指向了linux系统，在big-little方式中，部分中断指向了linux系统，另一部分中断指向了liteos。那么能不能在multicore方式中使中断指向liteos呢？

在linux系统中，通过对linux系统打海思官方提供的补丁得到海思的定制系统，其中中断部分的代码位于```drivers/irqchip/```路径，其中初始化位于```irq-gic.c```中，中断向量表位于```irq-map-hi3559av100.h```中。


其中初始化函数如下，该函数主要是将linux补丁中的中断向量表写入芯片配置：
```c
static void gic_dist_init_amp(struct gic_chip_data *gic)
{
	unsigned int i;
	u32 cpumask;
	unsigned int *irq_map_int = (unsigned int *)irq_map;					//这是中断向量表的位置
	unsigned int gic_irqs = gic->gic_irqs;
	void __iomem *base = gic_data_dist_base(gic);

	writel_relaxed(GICD_DISABLE, base + GIC_DIST_CTRL);

	/*
	 * Set all global interrupts to this CPU only.
	 */
	for (i = 32; i < gic_irqs; i += 4) {
	    cpumask = irq_map_int[i / 4];
		writel_relaxed(cpumask, base + GIC_DIST_TARGET + i * 4 / 4);		//设置中断向量表
	}

	gic_dist_config(base, gic_irqs, NULL);

	writel_relaxed(GICD_ENABLE, base + GIC_DIST_CTRL);
}

```

其中big-little和multicore都存在该部分代码，但是在不同的方式下，有不同的效果，说明执行条件不一样，因此需要看该部分代码的执行条件。
```c
//已经删除其他无关代码
static int gic_init_bases(struct gic_chip_data *gic, int irq_start,
			  struct fwnode_handle *handle)
{

	int gic_dist_init_flag;

#define GIC_DIST_INIT_FLAG 0x47444946
#define GIC_DIST_INIT_FLAG_OFFSET 0x0130

	gic_dist_init_flag = readl(sysctrl_reg_base + GIC_DIST_INIT_FLAG_OFFSET);

	if(gic_dist_init_flag != GIC_DIST_INIT_FLAG) {
		printk("Gic dist init...\n");

		gic_dist_init_amp(gic);

		writel_relaxed(GIC_DIST_INIT_FLAG, sysctrl_reg_base + GIC_DIST_INIT_FLAG_OFFSET);
	} else
		printk("Gic dist not init...\n");

	ret = gic_cpu_init(gic);

	return ret;
}

```

如上代码所示：linux主要是通过判断```GIC_DIST_INIT_FLAG_OFFSET```是否写入了```0x47444946```来确定是否重新刷写中断向量表。


# 二、 中断分析-liteos部分
看一下A53UP中关于中断的代码，A53UP的中断配置位于sdk中的osdrv/osdrv/platform/liteos_a53/liteos_user/platform/bsp/board/hi3559av100/cortex-a53_aarch64/hi3559av100_aarch64_board.c中，该目录下也存在相对应的中断向量表，可以自行设置。

看一下配置代码：
```c

#define GIC_DIST_INIT_FLAG_OFFSET 0x0130
#define GIC_DIST_INIT_FLAG 0x47444946

VOID platform_gic_dist_init(unsigned int gic_nr, VOID *base, unsigned int irq_start)
{
    //已经删除了无关代码
    if(GET_UINT32(GIC_DIST_INIT_FLAG_BASE + GIC_DIST_INIT_FLAG_OFFSET) == GIC_DIST_INIT_FLAG)
        return;
	unsigned int *irq_dist = (unsigned int *)irq_map;
    WRITE_UINT32(0x0, addr_base + ARM_GIC_DIST_CTRL);

    max_irq = OS_HWI_MAX_NUM; //256 interrupts at most

    for (i = 32; i < max_irq; i += 16) {
        WRITE_UINT32(0x0, addr_base + ARM_GIC_DIST_CONFIG + i * 4 / 16);	//写入中断向量表
    }

    for (i = 32; i < max_irq; i += 4) {
#ifdef LOSCFG_PLATFORM_HISI_AMP
        /*
         * distribute all global interrupts to A53UP or A53MP-0
         */
        WRITE_UINT32(*irq_dist, addr_base + ARM_GIC_DIST_TARGET + i);
        irq_dist++;
#else
        /*
         * Set all global interrupts to this CPU only.
         */
        WRITE_UINT32(cpumask, addr_base + ARM_GIC_DIST_TARGET + i);
#endif
    }
    /*
     * Set priority on all interrupts.
     */
    for (i = 0; i < max_irq; i += 4) {
        WRITE_UINT32(0xa0a0a0a0, addr_base + ARM_GIC_DIST_PRI + i * 4 / 4);
    }

    /*
     * Disable all interrupts.
     */
    for (i = 0; i < max_irq; i += 32) {
        WRITE_UINT32(0xffffffff, addr_base + ARM_GIC_DIST_ENABLE_CLEAR + i * 4 / 32);
    }

    WRITE_UINT32(1, addr_base + ARM_GIC_DIST_CTRL);
#ifdef LOSCFG_PLATFORM_HISI_AMP
	WRITE_UINT32(GIC_DIST_INIT_FLAG, GIC_DIST_INIT_FLAG_BASE + GIC_DIST_INIT_FLAG_OFFSET);	//写入0x47444946
#endif
}
```

如上所述，中断应该不做任何处理就可以在multicore中使用。

# 三、 中断向量表
通过上述分析，在双系统中，所有的中断都可以liteos中设置，其文件位于```osdrv/platform/liteos_a53/liteos_user/platform/bsp/board/hi3559av100/cortex-a53_aarch64/include/irq_map.h```.

```c
#ifndef __IRQ_MAP_CONFIG_H__
#define __IRQ_MAP_CONFIG_H__

#define TO_A53MP0  (1<<0x00)
#define TO_A53MP1  (1<<0x01)
#define TO_A73MP0  (1<<0x02)
#define TO_A73MP1  (1<<0x03)
#define TO_A53UP_  (1<<0x04)  //Local
const unsigned char irq_map[OS_HWI_MAX_NUM-32] = {
	/*time 0   timer 2    timer 4    timer 6  */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53UP_, /* 32  ~ 35 */
	/*time 8   timer 10   uart 0     uart 1   */
	TO_A53UP_, TO_A53UP_, TO_A53MP0, TO_A53UP_, /* 36  ~ 39 */
	/*uart 2   uart 3     uart 4     RTC      */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 40  ~ 43 */
	/*i2c 0    i2c 1      i2c 2      i2c 3    */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 44  ~ 47 */
	/*i2c 4    i2c 5      i2c 6      i2c 7    */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 48  ~ 51 */
	/*i2c 8    i2c 9      i2c 10     i2c 11   */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53UP_,	/* 52  ~ 55 */
	/*IR       FMC        eMMC       VDMA   */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53UP_,	/* 56  ~ 59 */
	/*res      res        SPACC      SSP0   */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53UP_,	/* 60  ~ 63 */
	/*SSP1     SSP2       SSP3       SSP4   */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 64  ~ 67 */
	/*GMAC0    GMAC1      SOFTWARE   VEDU0   */
	TO_A53MP0, TO_A53UP_, TO_A53MP0, TO_A53UP_,	/* 68  ~ 71 */
	/*VEDU1    VEDU2      res        VGS0   */
	TO_A53UP_, TO_A53UP_, TO_A53MP0, TO_A53UP_,	/* 72  ~ 75 */
	/*VGS1     VPSS0      VPSS1      GDC0   */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 76  ~ 79 */
	/*GDC1     JPGE       res        GME   */
	TO_A53UP_, TO_A53UP_, TO_A53MP0, TO_A53UP_,	/* 80  ~ 83 */
	/*JPGD     TDE        GZIP       PGD   */
	TO_A53UP_, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 84  ~ 87 */
	/*IVE      res        NNIE0      NNIE1   */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 88  ~ 91 */
	/*VICAP    VIPROC0    VIPROC1    MIPI TX   */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 92  ~ 95 */
	/*HDMI     HDMI       HDMI       VDP0 */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_, /* 96  ~ 99 */
	/*VDP1     AIAO       DSP0       DSP1 */
	TO_A53MP0, TO_A53UP_, TO_A53MP0, TO_A53MP0,	/* 100 ~ 103*/
	/*DSP2     DSP3       SDIO0      SDIO1  */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 104 ~ 107*/
	/*SDIO2    SDIO_WA0   SDIO_WA1   SDIO_WA2  */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 108 ~ 111*/
	/*DDRPHY   DMAC0      DMAC1      UFS    */
	TO_A53MP0, TO_A53UP_, TO_A53MP0, TO_A53MP0,	/* 112 ~ 115*/
	/*USB 0    USB 1      SLVS-EC    res    */
	TO_A53MP0, TO_A53MP0, TO_A53UP_, TO_A53MP0,	/* 116 ~ 119*/
	/*MIPI RX  DDRT 0     DDRT 1     VDH_OLP    */
	TO_A53UP_, TO_A53MP0, TO_A53MP0, TO_A53UP_,	/* 120 ~ 123*/
	/*VDH_ILP  VDH_SAFE   VDH_NOR    VDH_MDMA    */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 124 ~ 127*/
	/*SSP5     SSP6       A53UP CCI  BL_CCI  */
	TO_A53MP0, TO_A53MP0, TO_A53UP_, TO_A53MP0,	/* 128 ~ 131*/
	/*GPU      GPU        GPU        GPU     */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 132 ~ */
	/*RSA      WDG        CAN 0      CAN 1   */
	TO_A53MP0, TO_A53UP_ | TO_A53MP0 | TO_A53MP1 | TO_A73MP0 | TO_A73MP1, TO_A53MP0, TO_A53MP0,	/* 136 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 140 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 144 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 148 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 152 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 156 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 160 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 164 ~ */
	/*A73MP_NCOMMIRQ1 PMU CTIIRQ0    COMMRX 0*/
	TO_A53MP0, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 168 ~ */
	/* COMMTX  NCOMMIRQ   PCIE       PCIE    */
	TO_A53UP_, TO_A53UP_, TO_A53MP0, TO_A53MP0,	/* 172 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 176 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 180 ~ */
	/* AVSP 0  AVSP 1     AVSP 2     AVSP 3  */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 184 ~ */
	/* AVSP 4  AVSP 5     AVSP 6     AVSP 7  */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53UP_,	/* 188 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 192 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 196 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 200 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 204 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 208 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 212 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 216 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 220 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 224 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 228 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 232 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 236 ~ */
	/*DPU_RECT DPU_MATCH  DPU_POSTPROC IPC_0  */
	TO_A53UP_, TO_A53UP_, TO_A53UP_, TO_A53MP0,	/* 240 ~ */
	/*IPC_1    IPC_2*/
	TO_A53MP0, TO_A53UP_, TO_A53MP0, TO_A53MP0,	/* 244 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 248 ~ */
	TO_A53MP0, TO_A53MP0, TO_A53MP0, TO_A53MP0,	/* 252 ~ */
};/* [32 - 255] */
#else
#error "should not include irq_map.h twice"
#endif

```


